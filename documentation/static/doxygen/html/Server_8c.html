<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SCU: Server/Server.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SCU
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_1a445cb237d74f7a5f8d11ec3b0585cc.html">Server</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">Server.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>The BLE server ran by Sensor Control Units.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdio.h&gt;</code><br />
<code>#include &quot;pico/stdlib.h&quot;</code><br />
<code>#include &quot;btstack.h&quot;</code><br />
<code>#include &quot;pico/unique_id.h&quot;</code><br />
<code>#include &quot;pico/btstack_cyw43.h&quot;</code><br />
<code>#include &quot;pico/cyw43_arch.h&quot;</code><br />
<code>#include &quot;SCU.h&quot;</code><br />
<code>#include &quot;hardware/i2c.h&quot;</code><br />
<code>#include &quot;<a class="el" href="seesaw_8h_source.html">../seesaw/seesaw.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="bh1750_8h_source.html">../bh1750/bh1750.h</a>&quot;</code><br />
<code>#include &quot;hardware/regs/rosc.h&quot;</code><br />
<code>#include &quot;hardware/regs/addressmap.h&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ae5078cf2056780a8896cb915c3a68741"><td class="memItemLeft" align="right" valign="top"><a id="ae5078cf2056780a8896cb915c3a68741"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>_I2C_</b></td></tr>
<tr class="separator:ae5078cf2056780a8896cb915c3a68741"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad9ecf80e1eac083d16ec47f9d3aeb39f"><td class="memItemLeft" align="right" valign="top"><a id="ad9ecf80e1eac083d16ec47f9d3aeb39f"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>I2C_PORT</b>&#160;&#160;&#160;i2c0</td></tr>
<tr class="separator:ad9ecf80e1eac083d16ec47f9d3aeb39f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a18aefd12ad84d4c33dc97923cb821e47"><td class="memItemLeft" align="right" valign="top"><a id="a18aefd12ad84d4c33dc97923cb821e47"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>I2C_SDA</b>&#160;&#160;&#160;4</td></tr>
<tr class="separator:a18aefd12ad84d4c33dc97923cb821e47"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a212ca328a6409c98f8c3dfbbe1ba561d"><td class="memItemLeft" align="right" valign="top"><a id="a212ca328a6409c98f8c3dfbbe1ba561d"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>I2C_SCL</b>&#160;&#160;&#160;5</td></tr>
<tr class="separator:a212ca328a6409c98f8c3dfbbe1ba561d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8095cd8bb3de52fffba928ed8ff15065"><td class="memItemLeft" align="right" valign="top"><a id="a8095cd8bb3de52fffba928ed8ff15065"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#a8095cd8bb3de52fffba928ed8ff15065">HEARTBEAT_MS</a>&#160;&#160;&#160;1000</td></tr>
<tr class="memdesc:a8095cd8bb3de52fffba928ed8ff15065"><td class="mdescLeft">&#160;</td><td class="mdescRight">server will "beat" every second <br /></td></tr>
<tr class="separator:a8095cd8bb3de52fffba928ed8ff15065"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a74821fd2e1652d4ab2fdb8148017993d"><td class="memItemLeft" align="right" valign="top"><a id="a74821fd2e1652d4ab2fdb8148017993d"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>APP_AD_FLAGS</b>&#160;&#160;&#160;0x06</td></tr>
<tr class="separator:a74821fd2e1652d4ab2fdb8148017993d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a60fddc244b6e322e857ca534d042b526"><td class="memItemLeft" align="right" valign="top"><a id="a60fddc244b6e322e857ca534d042b526"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>LEN_SENSOR_DATA</b>&#160;&#160;&#160;30</td></tr>
<tr class="separator:a60fddc244b6e322e857ca534d042b526"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a5c15d608421d42df9c53cfddb5e9f684"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#a5c15d608421d42df9c53cfddb5e9f684">heartbeat_handler</a> (struct btstack_timer_source *ts)</td></tr>
<tr class="memdesc:a5c15d608421d42df9c53cfddb5e9f684"><td class="mdescLeft">&#160;</td><td class="mdescRight">called every second to check the status of the Server  <a href="Server_8c.html#a5c15d608421d42df9c53cfddb5e9f684">More...</a><br /></td></tr>
<tr class="separator:a5c15d608421d42df9c53cfddb5e9f684"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aacde7bd56c0d76ff52f3d24a2cf265c6"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#aacde7bd56c0d76ff52f3d24a2cf265c6">packet_handler</a> (uint8_t packet_type, uint16_t channel, uint8_t *packet, uint16_t size)</td></tr>
<tr class="memdesc:aacde7bd56c0d76ff52f3d24a2cf265c6"><td class="mdescLeft">&#160;</td><td class="mdescRight">receive bt packets  <a href="Server_8c.html#aacde7bd56c0d76ff52f3d24a2cf265c6">More...</a><br /></td></tr>
<tr class="separator:aacde7bd56c0d76ff52f3d24a2cf265c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afaaee2592e69e560c0f02a74eba52563"><td class="memItemLeft" align="right" valign="top">static uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#afaaee2592e69e560c0f02a74eba52563">att_read_callback</a> (hci_con_handle_t connection_handle, uint16_t att_handle, uint16_t offset, uint8_t *buffer, uint16_t buffer_size)</td></tr>
<tr class="memdesc:afaaee2592e69e560c0f02a74eba52563"><td class="mdescLeft">&#160;</td><td class="mdescRight">called when a client reads the sensor data characteristic  <a href="Server_8c.html#afaaee2592e69e560c0f02a74eba52563">More...</a><br /></td></tr>
<tr class="separator:afaaee2592e69e560c0f02a74eba52563"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1836ea028b04701685deb4229f0f9baa"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#a1836ea028b04701685deb4229f0f9baa">att_write_callback</a> (hci_con_handle_t connection_handle, uint16_t att_handle, uint16_t transaction_mode, uint16_t offset, uint8_t *buffer, uint16_t buffer_size)</td></tr>
<tr class="memdesc:a1836ea028b04701685deb4229f0f9baa"><td class="mdescLeft">&#160;</td><td class="mdescRight">called when the client wants to sign up for notifications  <a href="Server_8c.html#a1836ea028b04701685deb4229f0f9baa">More...</a><br /></td></tr>
<tr class="separator:a1836ea028b04701685deb4229f0f9baa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a15137b6783463bd4cbfa500620e48ba5"><td class="memItemLeft" align="right" valign="top"><a id="a15137b6783463bd4cbfa500620e48ba5"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#a15137b6783463bd4cbfa500620e48ba5">getASSMsoilmoisture</a> ()</td></tr>
<tr class="memdesc:a15137b6783463bd4cbfa500620e48ba5"><td class="mdescLeft">&#160;</td><td class="mdescRight">wrapper for library call to read soil moisture level. Useful because it allows for easy error handling <br /></td></tr>
<tr class="separator:a15137b6783463bd4cbfa500620e48ba5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aea1cdb831ccca6493bb629a881269786"><td class="memItemLeft" align="right" valign="top"><a id="aea1cdb831ccca6493bb629a881269786"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#aea1cdb831ccca6493bb629a881269786">getASSMtempC</a> ()</td></tr>
<tr class="memdesc:aea1cdb831ccca6493bb629a881269786"><td class="mdescLeft">&#160;</td><td class="mdescRight">wrapper for library call to read soil temperature. Useful because it allows for easy error handling <br /></td></tr>
<tr class="separator:aea1cdb831ccca6493bb629a881269786"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aef6957e38c2157f1b8bc6488a7290a6c"><td class="memItemLeft" align="right" valign="top"><a id="aef6957e38c2157f1b8bc6488a7290a6c"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#aef6957e38c2157f1b8bc6488a7290a6c">getBH1750lux</a> ()</td></tr>
<tr class="memdesc:aef6957e38c2157f1b8bc6488a7290a6c"><td class="mdescLeft">&#160;</td><td class="mdescRight">wrapper for library call to read light level. Useful because it allows for easy error handling <br /></td></tr>
<tr class="separator:aef6957e38c2157f1b8bc6488a7290a6c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1225f583f0e6854c5f15dd64324fab33"><td class="memItemLeft" align="right" valign="top"><a id="a1225f583f0e6854c5f15dd64324fab33"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#a1225f583f0e6854c5f15dd64324fab33">write_sensor_data</a> ()</td></tr>
<tr class="memdesc:a1225f583f0e6854c5f15dd64324fab33"><td class="mdescLeft">&#160;</td><td class="mdescRight">write the data read by our sensors into a single string <br /></td></tr>
<tr class="separator:a1225f583f0e6854c5f15dd64324fab33"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a569afd45ab8da116294d71db8735e586"><td class="memItemLeft" align="right" valign="top"><a id="a569afd45ab8da116294d71db8735e586"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#a569afd45ab8da116294d71db8735e586">le_setup</a> ()</td></tr>
<tr class="memdesc:a569afd45ab8da116294d71db8735e586"><td class="mdescLeft">&#160;</td><td class="mdescRight">initializes the advertisements and function callbacks for BLE events <br /></td></tr>
<tr class="separator:a569afd45ab8da116294d71db8735e586"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aaf3fc70858f367a498620b20fccdd999"><td class="memItemLeft" align="right" valign="top"><a id="aaf3fc70858f367a498620b20fccdd999"></a>
uint32_t&#160;</td><td class="memItemRight" valign="bottom"><b>rnd</b> (void)</td></tr>
<tr class="separator:aaf3fc70858f367a498620b20fccdd999"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac7e912e031f0adcad3b70a11c37d9ce4"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#ac7e912e031f0adcad3b70a11c37d9ce4">print_id</a> (pico_unique_board_id_t *id)</td></tr>
<tr class="memdesc:ac7e912e031f0adcad3b70a11c37d9ce4"><td class="mdescLeft">&#160;</td><td class="mdescRight">print a unique ID for the SCU in use. Can be used to differentiating SCUs from each other to prevent accidental connections  <a href="Server_8c.html#ac7e912e031f0adcad3b70a11c37d9ce4">More...</a><br /></td></tr>
<tr class="separator:ac7e912e031f0adcad3b70a11c37d9ce4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae66f6b31b5ad750f1fe042a706a4e3d4"><td class="memItemLeft" align="right" valign="top"><a id="ae66f6b31b5ad750f1fe042a706a4e3d4"></a>
int&#160;</td><td class="memItemRight" valign="bottom"><b>main</b> ()</td></tr>
<tr class="separator:ae66f6b31b5ad750f1fe042a706a4e3d4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a78ac57d0fe855e659f11df8e7183d7f1"><td class="memItemLeft" align="right" valign="top"><a id="a78ac57d0fe855e659f11df8e7183d7f1"></a>
static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#a78ac57d0fe855e659f11df8e7183d7f1">read_sensors</a> = 0</td></tr>
<tr class="memdesc:a78ac57d0fe855e659f11df8e7183d7f1"><td class="mdescLeft">&#160;</td><td class="mdescRight">set to 1 when there's a connection, 0 if not <br /></td></tr>
<tr class="separator:a78ac57d0fe855e659f11df8e7183d7f1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aad11a528ae0ba8eda345832375589da5"><td class="memItemLeft" align="right" valign="top"><a id="aad11a528ae0ba8eda345832375589da5"></a>
static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#aad11a528ae0ba8eda345832375589da5">le_notify</a> = 0</td></tr>
<tr class="memdesc:aad11a528ae0ba8eda345832375589da5"><td class="mdescLeft">&#160;</td><td class="mdescRight">set to 1 when the client signs up to receive notifications, 0 otherwise <br /></td></tr>
<tr class="separator:aad11a528ae0ba8eda345832375589da5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af39db6274b8e6a0aaab7568a2ad2a854"><td class="memItemLeft" align="right" valign="top"><a id="af39db6274b8e6a0aaab7568a2ad2a854"></a>
static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#af39db6274b8e6a0aaab7568a2ad2a854">sensors_connected</a> = 1</td></tr>
<tr class="memdesc:af39db6274b8e6a0aaab7568a2ad2a854"><td class="mdescLeft">&#160;</td><td class="mdescRight">assume sensors aren't connected, set to 0 if they aren't found <br /></td></tr>
<tr class="separator:af39db6274b8e6a0aaab7568a2ad2a854"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3000348b1581ee844dfdc632d67bd652"><td class="memItemLeft" align="right" valign="top"><a id="a3000348b1581ee844dfdc632d67bd652"></a>
static btstack_timer_source_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#a3000348b1581ee844dfdc632d67bd652">heartbeat</a></td></tr>
<tr class="memdesc:a3000348b1581ee844dfdc632d67bd652"><td class="mdescLeft">&#160;</td><td class="mdescRight">timer source for heartbeat_handler <br /></td></tr>
<tr class="separator:a3000348b1581ee844dfdc632d67bd652"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a02bea55afda5d53df054b197b9f51f02"><td class="memItemLeft" align="right" valign="top"><a id="a02bea55afda5d53df054b197b9f51f02"></a>
static hci_con_handle_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#a02bea55afda5d53df054b197b9f51f02">con_handle</a></td></tr>
<tr class="memdesc:a02bea55afda5d53df054b197b9f51f02"><td class="mdescLeft">&#160;</td><td class="mdescRight">connection handle for notifications <br /></td></tr>
<tr class="separator:a02bea55afda5d53df054b197b9f51f02"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8bf2c8f8ea4d8cfcfd790084b8db517a"><td class="memItemLeft" align="right" valign="top"><a id="a8bf2c8f8ea4d8cfcfd790084b8db517a"></a>
static btstack_packet_callback_registration_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#a8bf2c8f8ea4d8cfcfd790084b8db517a">hci_event_callback_registration</a></td></tr>
<tr class="memdesc:a8bf2c8f8ea4d8cfcfd790084b8db517a"><td class="mdescLeft">&#160;</td><td class="mdescRight">for registering bt function callbacks <br /></td></tr>
<tr class="separator:a8bf2c8f8ea4d8cfcfd790084b8db517a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af99d0293652c2672eb579ed1fc0cce86"><td class="memItemLeft" align="right" valign="top"><a id="af99d0293652c2672eb579ed1fc0cce86"></a>
char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#af99d0293652c2672eb579ed1fc0cce86">sensor_data</a> [LEN_SENSOR_DATA]</td></tr>
<tr class="memdesc:af99d0293652c2672eb579ed1fc0cce86"><td class="mdescLeft">&#160;</td><td class="mdescRight">a string containing the sensor data separated by commas &ndash; the BLE characteristic that will be read by a client <br /></td></tr>
<tr class="separator:af99d0293652c2672eb579ed1fc0cce86"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a45d86a4d2a5bc9eb558d734cb7b48722"><td class="memItemLeft" align="right" valign="top"><a id="a45d86a4d2a5bc9eb558d734cb7b48722"></a>
uint8_t&#160;</td><td class="memItemRight" valign="bottom"><b>sensor_data_length</b> = 0</td></tr>
<tr class="separator:a45d86a4d2a5bc9eb558d734cb7b48722"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af461bf81ec9626a46878d6603997cba0"><td class="memItemLeft" align="right" valign="top"><a id="af461bf81ec9626a46878d6603997cba0"></a>
uint16_t&#160;</td><td class="memItemRight" valign="bottom"><b>soil_moisture</b> = 0</td></tr>
<tr class="separator:af461bf81ec9626a46878d6603997cba0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a42c4137e7cf1b6e09d086368c9a7ba3e"><td class="memItemLeft" align="right" valign="top"><a id="a42c4137e7cf1b6e09d086368c9a7ba3e"></a>
float&#160;</td><td class="memItemRight" valign="bottom"><b>tempC</b> = 0</td></tr>
<tr class="separator:a42c4137e7cf1b6e09d086368c9a7ba3e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a03162a568e0564f8c5bc49129f9a6aef"><td class="memItemLeft" align="right" valign="top"><a id="a03162a568e0564f8c5bc49129f9a6aef"></a>
float&#160;</td><td class="memItemRight" valign="bottom"><b>lux</b> = 0</td></tr>
<tr class="separator:a03162a568e0564f8c5bc49129f9a6aef"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9385025a88aa8328a92b1effac30c1e7"><td class="memItemLeft" align="right" valign="top">const uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="Server_8c.html#a9385025a88aa8328a92b1effac30c1e7">adv_data</a> []</td></tr>
<tr class="memdesc:a9385025a88aa8328a92b1effac30c1e7"><td class="mdescLeft">&#160;</td><td class="mdescRight">advertisement data that will be received by clients  <a href="Server_8c.html#a9385025a88aa8328a92b1effac30c1e7">More...</a><br /></td></tr>
<tr class="separator:a9385025a88aa8328a92b1effac30c1e7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa9d8dd7838b931d86ceaf57c915b65ef"><td class="memItemLeft" align="right" valign="top"><a id="aa9d8dd7838b931d86ceaf57c915b65ef"></a>
const uint8_t&#160;</td><td class="memItemRight" valign="bottom"><b>adv_data_len</b> = sizeof(<a class="el" href="Server_8c.html#a9385025a88aa8328a92b1effac30c1e7">adv_data</a>)</td></tr>
<tr class="separator:aa9d8dd7838b931d86ceaf57c915b65ef"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>The BLE server ran by Sensor Control Units. </p>
<dl class="section author"><dt>Author</dt><dd>Sam Gandolfo-Lucia </dd></dl>
<dl class="section version"><dt>Version</dt><dd>0.1 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>2023-12-17</dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright (c) 2023 </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="afaaee2592e69e560c0f02a74eba52563"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afaaee2592e69e560c0f02a74eba52563">&#9670;&nbsp;</a></span>att_read_callback()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static uint16_t att_read_callback </td>
          <td>(</td>
          <td class="paramtype">hci_con_handle_t&#160;</td>
          <td class="paramname"><em>connection_handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>att_handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>buffer_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>called when a client reads the sensor data characteristic </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">connection_handle</td><td>not used, but required by btstack </td></tr>
    <tr><td class="paramname">att_handle</td><td>should match the handle for our sensor data characteristic </td></tr>
    <tr><td class="paramname">offset</td><td></td></tr>
    <tr><td class="paramname">buffer</td><td></td></tr>
    <tr><td class="paramname">buffer_size</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>uint16_t</dd></dl>
<p>called anytime a client attempts to read our sensor data characteristic reads all of the sensors data into variables and then writes it to a string the string is what is read by the clients </p>

</div>
</div>
<a id="a1836ea028b04701685deb4229f0f9baa"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1836ea028b04701685deb4229f0f9baa">&#9670;&nbsp;</a></span>att_write_callback()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">int att_write_callback </td>
          <td>(</td>
          <td class="paramtype">hci_con_handle_t&#160;</td>
          <td class="paramname"><em>connection_handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>att_handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>transaction_mode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>offset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>buffer_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>called when the client wants to sign up for notifications </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">connection_handle</td><td>used to notify the client of updates to the sensor data characteristic </td></tr>
    <tr><td class="paramname">att_handle</td><td>should match the sensor data characteristic configuration handle </td></tr>
    <tr><td class="paramname">transaction_mode</td><td>not used, but required by btstack </td></tr>
    <tr><td class="paramname">offset</td><td>not used, but required by btstack </td></tr>
    <tr><td class="paramname">buffer</td><td></td></tr>
    <tr><td class="paramname">buffer_size</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>int</dd></dl>
<p>called anytime there's an attempt to write to the characteristic in our case the only valid write is signing up for notifications aka the client can never write to our sensor data characteristic in order to change its value </p>

</div>
</div>
<a id="a5c15d608421d42df9c53cfddb5e9f684"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5c15d608421d42df9c53cfddb5e9f684">&#9670;&nbsp;</a></span>heartbeat_handler()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void heartbeat_handler </td>
          <td>(</td>
          <td class="paramtype">struct btstack_timer_source *&#160;</td>
          <td class="paramname"><em>ts</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>called every second to check the status of the Server </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ts</td><td>the timer source (aka interval) for the function to be called on</td></tr>
  </table>
  </dd>
</dl>
<p>this function is called repeatedly on the interval defined by HEARTBEAT_MS aka in this case it is called every second. ts is a pointer to the globally defined heartbeat variable </p>

</div>
</div>
<a id="aacde7bd56c0d76ff52f3d24a2cf265c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aacde7bd56c0d76ff52f3d24a2cf265c6">&#9670;&nbsp;</a></span>packet_handler()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void packet_handler </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>packet_type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>channel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>packet</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>receive bt packets </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">packet_type</td><td></td></tr>
    <tr><td class="paramname">channel</td><td>is not used, but required by bystack </td></tr>
    <tr><td class="paramname">packet</td><td>the actual data contained in the packet </td></tr>
    <tr><td class="paramname">size</td><td>is not used, but required by btstack</td></tr>
  </table>
  </dd>
</dl>
<p>deals with all bt packets received basically the only ones we care about are client connect, disconnect, and notify </p>

</div>
</div>
<a id="ac7e912e031f0adcad3b70a11c37d9ce4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac7e912e031f0adcad3b70a11c37d9ce4">&#9670;&nbsp;</a></span>print_id()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void print_id </td>
          <td>(</td>
          <td class="paramtype">pico_unique_board_id_t *&#160;</td>
          <td class="paramname"><em>id</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>print a unique ID for the SCU in use. Can be used to differentiating SCUs from each other to prevent accidental connections </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">id</td><td>the board ID </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a9385025a88aa8328a92b1effac30c1e7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9385025a88aa8328a92b1effac30c1e7">&#9670;&nbsp;</a></span>adv_data</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const uint8_t adv_data[]</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Initial value:</b><div class="fragment"><div class="line">= {</div>
<div class="line">    </div>
<div class="line">    0x02, BLUETOOTH_DATA_TYPE_FLAGS, APP_AD_FLAGS,</div>
<div class="line">    </div>
<div class="line">    0x07, BLUETOOTH_DATA_TYPE_COMPLETE_LOCAL_NAME, <span class="charliteral">&#39;C&#39;</span>, <span class="charliteral">&#39;a&#39;</span>, <span class="charliteral">&#39;n&#39;</span>, <span class="charliteral">&#39;a&#39;</span>, <span class="charliteral">&#39;r&#39;</span>, <span class="charliteral">&#39;y&#39;</span>,</div>
<div class="line">    0x03, BLUETOOTH_DATA_TYPE_COMPLETE_LIST_OF_16_BIT_SERVICE_CLASS_UUIDS, 0x1a, 0x18,</div>
<div class="line">}</div>
</div><!-- fragment -->
<p>advertisement data that will be received by clients </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
